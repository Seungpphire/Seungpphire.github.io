---
title:  "[업무] 이슈- Caloriemeter Circuit reset error issue"
# excerpt: 

categories: 업무
toc: false
toc_sticky: false
 
date: 2021-08-02
last_modified_at:  2021-08-02
published : true
---

## STEP 1. 이슈 증상 

증상재현방법 : 

1) 외부전원 연결, 내부전원 제거된 상태에서 mcu 공급전압 정상, 디바이스 동작 정상
2) 외부전원 제거, 일정시간 후 C 방전됨
3) 방전 후 3-4초 후 외부전원 인가  
4) Reset 회로 동작 이상, 전원복귀 안됨

먼저 위의 증상재현방법을 조금더 단순화하자. 어떤 상황에서 어떻게 동작하는지에 대한  범위를 좁혀야 한다.
하여 동일한 조건의 TEST SAMPLE 2개를 이용해 도대체 어떤 상황에서만 증상이 발생하는지를 찾아보자.

```
case1) 
- 내부전원 인가 > 충분한 시간 > 내부전원 제거 > 완전 방전시 외부전원 인가 > 결과확인

case1 결과)
- SAMPLE1: 증상재현성공
(외부전원 제거 후, +3초에 bat 저전압 알람/ +7초에 완전방전, 재인가시 복귀 안됨)
- SAMPLE2: 증상재현성공 
(외부전원 제거 후, +4초에 bat 저전압 알람/ +8초에 완전방전, 재인가시 복귀 안됨)
```

```
case2)
- 내부전원 인가 > 충분한 시간 > 내부전원 제거 > 50% 방전시 외부전원 인가 > 결과확인

case2 결과)
- SAMPLE1: 증상재현실패 (배터리단에서 전압이 측정되면 복귀됨)
- SAMPLE2: 증상재현실패 (배터리단에서 전압이 측정되면 복귀됨)
```

```
case3)
- 내부전원 인가 > 충분한 시간 > 내부전원 제거 > 90% 방전시 외부전원 인가 > 결과확인

case3)
- SAMPLE1: 증상재현실패 (배터리단 완전방전 직전까지는 전원 복귀됨)
- SAMPLE2: 증상재현실패 (배터리단 완전방전 직전까지는 전원 복귀됨)
```
```
case4) 
- 외부전원 인가 > 충분한 시간 > 내부전원 제거 > 완전 방전시 외부전원 인가 > 결과확인

case4 결과)
- SAMPLE1: 증상재현성공 
(외부전원 제거 후, +3초에 bat 저전압 알람/ +7초에 완전방전, 재인가시 복귀 안됨)
- SAMPLE2: 증상재현성공 
(외부전원 제거 후, +4초에 bat 저전압 알람/ +8초에 완전방전, 재인가시 복귀 안됨)
```

```
case5)
- 외부전원 인가 > 충분한 시간 > 외부전원 제거 > 50% 방전시 외부전원 인가 > 결과확인

case5 결과)
- SAMPLE1: 증상재현실패 (외부전원단이 전압이 측정되면 복귀됨)
- SAMPLE2: 증상재현실패 (외부전원단이 전압이 측정되면 복귀됨)
```

```
case6)
- 외부전원 인가 > 충분한 시간 > 외부전원 제거 > 90% 방전시 외부전원 인가 > 결과확인

case6)
- SAMPLE1: 증상재현실패 (외부전원단 완전방전 직전까지는 전원 복귀됨)
- SAMPLE2: 증상재현실패 (외부전원단 완전방전 직전까지는 전원 복귀됨)
```

처음 설정했던 재현상황을 단순화 하였다. 

1) 내부전원 및 외부전원 제거하여 C 완전방전상태 
2) 외부전원만 연결
3) Reset 회로 동작 이상, 전원복귀 안됨


중간결론)
내부전원은 외부전원의 동작에 전혀 영향을 받지 않고 독립적으로 잘 동작하지만
외부전원은 내,외부 전원전압에 영향을 받는다. 
외부전원은 내,외부 전원전압이 완전방전 상태가 되는 경우 이상 증상을 보이지만 조금이라도 전원에 전압이 인가되면 정상동작한다.  



## STEP 2. 원인 분석

문제가 되는 회로를 살펴본다.
![image](https://user-images.githubusercontent.com/82863114/127818620-75365d2e-d1d5-4ee9-8caa-45097c54ad57.png)

회로는 외부전압(11V)에서 전원을 켜는 부분과 내부전압(3.6V)에서 전원을 켜는 부분으로 나누어져 있다. 내부전압이 없으면 외부전압을 쓰고, 외부전압이 없으면 내부전압을 쓰는 식의 회로이다.

여기서 문제는 아래와 같이 내부전압이 있을때와 없을때의 소모전류 차이가 매우 심하다. 
![image](https://user-images.githubusercontent.com/82863114/127821567-96ba14d7-642c-4b80-9b04-621c78feff4b.png)

외부전압만 연결 > 제거 > 연결 > 제거 > 내부전압 연결
왼쪽의 그래프를 보면 외부전압만을 연결했을 때의 소모전류를 나타내는데 오른쪽 그래프와는 확연히 차이가 있다. 오른쪽 그래프는 처음 전류를 끌어올때 약 7mA 정도를 소모하고 그 이후에는 micro단위로 안정화가 된다. 그에 반해 왼쪽그래프는 처음 전류를 끌어올 때 약 7mA를 소모하고도 지속적으로 5mA 정도의 전류를 어디선가 먹고 있다. 

아래는 내부전압이 50% 방전 되었을 때와 100% 방전 되었을때에 각각 외부전압을 인가한 그래프다.
![image](https://user-images.githubusercontent.com/82863114/127822955-0f34e714-f91d-4f2c-9319-ae9430be3b2f.png)

확실히 50% 방전시점에 외부전압을 주면 소모전류가 micro단위로 차츰 떨어져 안정화가 되지만 완전방전된 시점에 외부전압을 주면 소모전류가 많이 먹고 있음을 알 수 있다.
(이 때 외부전원의 전압또한 drop되어 4v 정도밖에 나오지 않는다.)

오늘은 여기까지. 
전류가 어디서 그렇게 많이 먹는걸까..

reference
내 머리