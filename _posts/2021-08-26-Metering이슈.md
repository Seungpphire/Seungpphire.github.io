---
title:  "[업무] 이슈- Caloriemeter Metering, Sensing error issue"
# excerpt: 

categories: 업무
toc: false
toc_sticky: false
 
date: 2021-08-26
last_modified_at:  2021-08-26
published : true
---

## STEP 1. 이슈 증상 
유량 적산이 안되는 이슈가 접수되었고, 해당 문제에 대한 원인분석 요청이 있었다. 
Caloriemeter는 아래와 같은 순서로 요약해 볼 수 있다.
1) 적산유량값의 변화를 감지 --> 2) EEPROM 적산유량값을 저장 --> 3) 일정량(10L)의 유량을 감지하면 온도상태를 업데이트 --> 4) 읽어온 온도값에 대한 열량값을 계산 --> 5) 적산열량값을 표현

이 과정중, 현재 A,B 증상은 위의 순서중 각각 1) 단계 이전의 문제, 4) 단계 이전의 문제라고 할 수 있다. 
지금처럼 개발초기에 이러한 증상이 발생하면 반드시 불량발생지점을 찾아 발생가능성을 최소화해야 한다. 먼저 A부터 살펴보자.

## STEP 2. 원인 분석

A) 유량적산이 안됨
그 원인이 될 수 있는 요인은 매우 다양하다. 

- 기구
- H/W
- F/W (특정상황에서만 이런 증상이 나타나도록 되어있을 가능성 있음) 
- 기타 

센싱에 관여하는 회로에 접근해 문제를 해결해 보도록 하자.
해당 제품은 자성을 띈 기구로 둘러싸여 있고, Magnetic Resistance(MR) 센서를 이용하여 이를 측정하도록 설계되었다. 현재는 TMR 각도센서 2개를 사용하여 성능과 비용 효율을 높힌 상태이다.

**TMR 센서의 동작원리**
이슈 내용을 분석하기에 앞서, 센서에 대해 간단히 알아보면, TMR 센서는 Magnetic Field의 방향을 이용한 IC이다.
![image](https://user-images.githubusercontent.com/82863114/131072086-809e45f2-7d41-45dc-ae31-606a1e1c47ca.png)

Free Layer라고 되어있는 층의 자화방향이 외부 자기장의 방향에 따라 변하게 되는 반면 Pin Layer라고 되어있는 층의 자화방향은 고정되어 있어, 이 두 방향이 평행이면 왼쪽 그림과 같이 저항은 작아지고 도통하는데 이 두 방향이 역평행이면 오른쪽 그림과 같이 저항이 커지면서 전류가 흐르게 된다. 


TMR 센서 위에 자석을 놓고 회전을 시키면 위와 같은 원리에 따라 소자의 저항이 계속적으로 변하게 된다. 이 소자의 저항이 변하게 되면서 전류는 흐르고 멈추기를 반복하게 되며, 이 주기를 읽어내어 실제 흐른 물의 양을 추측하게 되는 방식이 바로 Magnetic Field를 이용한 추측식이다. (반대는 실측식, 카운터를 이용한 방식이다.)

**TMR 센서부 이상**
예상되는 몇가지 원인 중 하나는 위의 TMR 센서의 각도로 인한 감도부족이다. TMR을 2개 사용하면 유속계산을 보다 정확하게 할 수 있다. 

![image](https://user-images.githubusercontent.com/82863114/131074760-cacc72cc-6414-49a9-8bd1-b826c046fb3f.png)

위와 같이 2개의 센서를 조합하면 기존의 2가지 상태만을 가공하여 판단하는 방식에서 나아가 네 가지 상태를 가공하여 데이터를 판단할 수 있게 된다. 
상태는 다음과 같다.
- H,H
- H,L
- L,L
- L,H

H(High)와 L(Low)의 조합으로 만들어진 네 가지의 상태는 그 순서나 주기를 사용하여 보다 신뢰도 있는 데이터를 만들어 내는데 도움이 된다.

![image](https://user-images.githubusercontent.com/82863114/131074052-0e90a064-6da9-46f6-bfc7-b135f6a504c9.png)

위 부분의 감도가 문제가 될 수 있다는 가정하에 정상시료와 문제시료의 회로를 교체해 테스트 했지만 동일하게 유량센싱기능은 복귀되지 않았다. 감도의 문제는 아니었다. 

## STEP 3. 결과

회로를 트러블슈팅 할때에는 스코프와 멀티미터를 이용해 문제지점에서 출발해 비교분석하면 금방 원인을 알 수 있다. 회로를 따라가던 중 원인이 발견되었는데, 다행히 커넥터 입력단에 코팅액이 흘러들어 접불이었다. 공정의 문제로 발견되었으니 원인분석서를 해당 부서로 전달해주면 될 것 같다.

-----
<!-- 

B) 온도센서에러 로그 남아있음.
리셋전까지 온도센서는 에러로그가 계속 남아있으며, 정상품으로 교체해도 여전히 온도값은 표현되지 않는다. 온도센서는 증상이 특이한데, 10L가 흐르면 반드시 온도값을 업데이트 하도로 설계되어 있지만 온도값 업데이트가 되지 않고 이전 온도값을 계속 가지고 계산해버리는 문제가 있다. 

문제상황 재현방법
1. 온도를 24도 24도로 설정하고 유량을 흘린다.
2. 해당 온도를 잘 읽고 있는 모르겠지만 상관없다. 한번이라도 해당상태를 만든다.  (확인됨)
3. 이 상태에서 다른 온도값으로 설정된 케이블을 연결한다. 80도 40도
4. 10L가 흐를때마다 새로운 온도값을 읽어야 하는데, 이전 24도 24도를 계속 읽게된다. 

![image](https://user-images.githubusercontent.com/82863114/130930378-16bb2eb6-5832-4d0a-bfe2-198f4d312fb5.png)

위의 Vout 소자가 1.5v 출력을 정상적으로 내고 있는지를 확인한다. 이 부분이 냉땜에면 정상 작동하지 않을 것이다. 10L 튈때마다 어떻게 이 소자가 변하는지 잘 보고, 냉땜을 확인한다.  -->